# 状態管理の基本的な考え方

状態管理の基本的な考え方を思いつくには、いくつかの段階と、問題解決への一般的なアプローチが組み合わさっています。以下に、その思考プロセスを段階的に解説します。

## 1. 問題の認識: フォームの状態を管理したい

まず、フォームの動作を実装する際に、「何が変化するのか？」「何を覚えておく必要があるのか？」という問題意識を持つことが出発点です。

- **入力値**: 各フィールドに入力された値は常に変化します。
- **バリデーション結果**: 各フィールドの入力が正しいかどうかという状態も変化します。
- **フォーム全体の有効性**: すべての必須項目が正しく入力されているかどうかという状態も変化します。
- **送信ボタンの活性/非活性**: フォーム全体の有効性に応じて変化します。
- **エラーメッセージの表示/非表示**: バリデーションの結果に応じて変化します。

これらの「状態」を個別の変数で管理しようとすると、数が多くなり、管理が煩雑になることが予想されます。

## 2. 関連する状態をまとめる: オブジェクトの利用

次に、「関連する情報は一つにまとめて管理した方が扱いやすい」という考えに至ります。ここでは、フォーム全体のバリデーションに関する状態をまとめるためにオブジェクト (`formState`) を利用します。

- フォーム全体の有効性を表す `isValid` プロパティ。
- 各入力フィールドのバリデーション状態を個別に管理するための `fields` プロパティ（これもオブジェクト）。

このように、関連する情報を階層的にオブジェクトにまとめることで、コードの見通しが良くなり、管理もしやすくなります。

## 3. 状態の更新と参照を抽象化する: メソッドの導入

状態を直接変更するのではなく、「状態を更新するための専用の関数」と「状態を参照するための関数」を用意することで、より安全で予測可能な状態管理を目指します。

- **`updateState(field, isValid)`**: 特定のフィールドのバリデーション状態を更新し、それに応じてフォーム全体の有効性を再計算する役割を持ちます。この関数があることで、「どのフィールドがどのように変化したか」という情報を一箇所に集約できます。また、ボタンの活性/非活性という副作用もこの関数内で管理できます。
- **`checkAllValid()`**: `fields` オブジェクト内のすべてのバリデーション結果を確認し、フォーム全体が有効かどうかを返す役割を持ちます。この関数があることで、フォームの有効性を確認するロジックを再利用でき、コードが簡潔になります。

## 4. イベントリスナーとの連携

フォームの入力イベント（`blur`, `input`, `change`, `submit` など）が発生した際に、上記で定義した状態管理の仕組みと連携させることを考えます。

- 入力フィールドの `blur` イベントが発生したら、そのフィールドのバリデーションを行い、その結果を `formState.updateState()` で更新します。
- 送信ボタンの `disabled` 属性を `formState.isValid` の値に基づいて動的に制御します。
- フォームの `submit` イベントが発生したら、最終的なバリデーションを行い、`formState.isValid` が `true` であれば送信処理を実行します。

## 5. DRY原則 (Don't Repeat Yourself)

コード全体を通して、同じようなロジックを何度も書かないように意識します。例えば、各フィールドのバリデーション処理は個別の関数 (`furiganaValidation`, `emailValidation` など) に分離し、再利用性を高めています。

## 思考のポイント

1. **何が状態か？** アプリケーション内で変化し、覚えておく必要のある情報を特定する。
2. **状態をどう構造化するか？** 関連する状態をまとめて管理しやすいように、オブジェクトなどのデータ構造を利用する。
3. **状態の変更をどう制御するか？** 直接状態を変更するのではなく、明確なインターフェース（関数やメソッド）を通して行うことで、予測可能性を高める。
4. **状態の参照をどう行うか？** 状態を読み取るための明確な方法を提供する。
5. **副作用をどこで管理するか？** 状態の変化に伴って発生するUI更新など、副作用は状態管理ロジックと関連付ける。

このコードは比較的小規模なフォーム状態管理という具体的な問題解決例ですが、上記段階的思考とプログラミング基本原則（構造化・抽象化・DRY原則など）によって成り立っています。

より複雑なアプリケーションでは、この基本的な考え方から発展させて専用状態管理ライブラリやアーキテクチャパターンも取り入れることになります。

> Gemini 2025/04/09